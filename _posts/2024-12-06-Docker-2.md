---
layout: post
title: Docker ê¸°ì´ˆ 2
subtitle: TIL Day 75
cover-img: "/assets/img/background.png"
thumbnail-img: ''
share-img: ''
tags: [TIL, Tools]
author: polaris0208
---

# Docker 2
> ì§ì ‘ ì‘ì„±í•œ íŒŒì´ì¬ ì½”ë“œë¡œ **github actions** í…ŒìŠ¤íŠ¸

## Github Actions
- **Github**ì— ë‚´ì¥ëœ **CI/CD** ë„êµ¬
    - **github**ì™€ í†µí•©ì´ ìš©ì´
    - **CI/CD** ì„œë²„ ë‚´ì¥
    -  ì¼ì • ìˆ˜ì¤€ê¹Œì§€ ê°€ê²©ì´ ë¬´ë£Œ
        - ë¬´ë£Œ ë²„ì „ : ìŠ¤í† ë¦¬ì§€ 500MB, ì›” 2000ë¶„
- **Github Actions** ë™ì‘ ë°©ë²•
    - **repository**ì˜ `.github/workflows` ë””ë ‰í† ë¦¬ ìƒì„±
    - í•„ìš”í•œ **Actions** íŒŒì¼ë“¤ì„ `yaml` í˜•ì‹ìœ¼ë¡œ ì‘ì„±

### CI
- ë³€ê²½ì‚¬í•­ì´ **Push, Merge. Pullrequest** ë˜ëŠ” ê²½ìš°
  - ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

#### ì˜ˆì‹œ í”„ë¡œì íŠ¸ ìƒì„±

```
project/
â”œâ”€â”€ calc/
â”‚   â””â”€â”€ calculator.py
â”œâ”€â”€ test_calculator.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ python-tests.yml
```

#### `calculator.py`
- ê°„ë‹¨í•œ ê³„ì‚° ê¸°ëŠ¥

```py
def add(a, b):
    return a + b

def subtract(a, b):
    return a - b

def multiply(a, b):
    return a * b

def divide(a, b):
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b
```

#### `test_calculator.py`
- `pytesy` : **Python** í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬
  - `test_*.py` ë˜ëŠ” `*_test.py` ì²˜ëŸ¼ `test`ê°€ í¬í•¨ëœ íŒŒì¼ì„ ì°¾ì•„ í…ŒìŠ¤íŠ¸
  - `assert` ë’¤ì— ì˜¤ëŠ” í‘œí˜„ì‹ì´ `True`ì¸ì§€ í™•ì¸
  - `@pytest.mark.parametrize` : ì—¬ëŸ¬ê°œì˜ íŒŒë¼ë¯¸í„°ë¥¼ í…ŒìŠ¤íŠ¸

```py
import pytest
from src.calculator import add, subtract, multiply, divide

# ê¸°ë³¸ í…ŒìŠ¤íŠ¸
def test_add():
    assert add(2, 3) == 5
    assert add(-1, 1) == 0

def test_subtract():
    assert subtract(10, 5) == 5
    assert subtract(0, 5) == -5

def test_multiply():
    assert multiply(3, 4) == 12
    assert multiply(-2, 3) == -6

# ì˜ˆì™¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
def test_divide():
    assert divide(10, 2) == 5
    assert divide(9, 3) == 3

    with pytest.raises(ValueError):
        divide(10, 0)

# íŒŒë¼ë¯¸í„°í™” í…ŒìŠ¤íŠ¸
@pytest.mark.parametrize("a, b, expected", [
    (1, 1, 2),
    (2, 3, 5),
    (-1, -1, -2),
    (0, 5, 5),
])
def test_add_parametrize(a, b, expected):
    assert add(a, b) == expected
```

#### `requirements.txt`
- í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ì˜ì¡´ì„± íŒŒì¼ ë“±ë¡
- `pytest` ì¶”ê°€

#### `python-tests.yml`
- ì‹¤í–‰ : `main`, `develop` ì—ì„œ **push** ë˜ëŠ” **PR** í•œ ê²½ìš°
- ì‘ì—… : `build` - `ubuntu-latest` í™˜ê²½ì—ì„œ ì§„í–‰
- ë‹¨ê³„
  - `repository` í™•ì¸
  - **Python** ì¤€ë¹„
  - ì˜ì¡´ì„± íŒŒì¼ ì„¤ì¹˜ : `pip`, `pytest`
  - `pytest -v`
    - `pytest`: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - `-v` : ìƒì„¸í•˜ê²Œ(**verbose**) ì¶œë ¥ / í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì˜ ì´ë¦„, ì‹¤í–‰ ìˆœì„œ, í†µê³¼/ì‹¤íŒ¨ ì •ë³´ë¥¼ ë” ëª…í™•í•˜ê²Œ í‘œì‹œ

```yaml
name: Run Python Tests

on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest -v
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼
- `main` ì—ì„œ **push**

```bash
Current runner version: '2.321.0'
Operating System
Runner Image
Runner Image Provisioner
GITHUB_TOKEN Permissions
Secret source: Actions
Prepare workflow directory
Prepare all required actions
Getting action download info
Download action repository 'actions/checkout@v4' (SHA:11bd71901bbe5b1630ceea73d27597364c9af683)
Download action repository 'actions/setup-python@v4' (SHA:65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236)
Complete job name: build
...
Run pytest -v
============================= test session starts ==============================
platform linux -- Python 3.9.20, pytest-8.3.4, pluggy-1.5.0 -- /opt/hostedtoolcache/Python/3.9.20/x64/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/work/CI-CD_sample/CI-CD_sample
collecting ... collected 8 items

test_calculator.py::test_add PASSED                                      [ 12%]
test_calculator.py::test_subtract PASSED                                 [ 25%]
test_calculator.py::test_multiply PASSED                                 [ 37%]
test_calculator.py::test_divide PASSED                                   [ 50%]
test_calculator.py::test_add_parametrize[1-1-2] PASSED                   [ 62%]
test_calculator.py::test_add_parametrize[2-3-5] PASSED                   [ 75%]
test_calculator.py::test_add_parametrize[-1--1--2] PASSED                [ 87%]
test_calculator.py::test_add_parametrize[0-5-5] PASSED                   [100%]

============================== 8 passed in 0.03s ===============================
```

### CD
- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë°°í¬
- ë°°í¬ë¥¼ ìœ„í•œ **TOKEN** ì„¤ì •
- `Repository/Settings/Security/Secrets and variables/Actions`
  - `github token` : `Profile/Settings/Developer settings/Persinal access tokens/Tokens (classic)`
    - ê¶Œí•œ ì„¤ì • : `repo, workflow, admin:punlic_key`
  - **Cloudtype API Key** : **Github** ê³„ì •ìœ¼ë¡œ ê°€ì••í›„ ë°œê¸‰
    - ê²°ì œ ë°©ë²• ë“±ë¡ í›„ ë¬´ë£Œ ì‚¬ìš© ê°€ëŠ¥

#### ì˜ˆì‹œ í”„ë¡œì íŠ¸ ë°°í¬
- ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± : `polaris0208`
- í”„ë¡œì íŠ¸ ìƒì„± : ë ˆí¬ì§€í† ë¦¬ì™€ ì—°ê²° / `ci-cd-sample`
- **YAML** íŒŒì¼ ì‘ì„± : `deploy_main.yml`

```yaml
name: Deploy to Cloudtype

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œê°€ ë°œìƒí•˜ë©´ ë°°í¬ê°€ ì§„í–‰ë¨
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œ ë°°í¬ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v3

      # 2. ë°°í¬ í‚¤ ì—°ê²°
      - name: Connect deploy key
        uses: cloudtype-github-actions/connect@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}  # Cloudtype ë°°í¬ í† í°
          ghtoken: ${{ secrets.GHP_TOKEN }}  # GitHub í† í°

      # 3. ë°°í¬ ì‹¤í–‰
      - name: Deploy
        uses: cloudtype-github-actions/deploy@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}  # Cloudtype ë°°í¬ í† í°
          project: polaris0208/ci-cd-sample  # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„/í”„ë¡œì íŠ¸ ì´ë¦„
          stage: main  # ë°°í¬í•  ìŠ¤í…Œì´ì§€ (ì˜ˆ: main)
          yaml: |
            name: ci-cd-sample  # í”„ë¡œì íŠ¸ ì´ë¦„
            app: python@3.9  # ì•± ì´ë¦„ ë° ë²„ì „ (ì˜ˆ: python@3.9)
            options:
              ports: 8080  # ì•±ì—ì„œ ì‚¬ìš©í•  í¬íŠ¸
            context:
              git:
                url: git@github.com:${{ github.repository }}.git  # GitHub ë ˆí¬ì§€í† ë¦¬ URL
                ref: ${{ github.ref }}  # Git ì°¸ì¡° (ë¸Œëœì¹˜ ë˜ëŠ” íƒœê·¸)
              preset: python-flask  # ì•± ì¢…ë¥˜ (ì˜ˆ: Flask)
```

#### ê²°ê³¼
- `start` ì„¤ì •ì„ í•˜ì§€ ì•Šì•„ì„œ ì‹¤í–‰ì€ ë˜ì§€ ì•ŠìŒ
  - `flask` ë˜ëŠ” `fastapi` ë“±ìœ¼ë¡œ ì‹¤í–‰ ì„¤ì • í•„ìš”

```
Run cloudtype-github-actions/connect@v1
â­ Connect polaris0208/CI-CD_sample with (your) scope ghtoken is ***
ğŸ‘€ Deploy Key is .... polaris0208@cloudtype
âœ… Success - init

Run cloudtype-github-actions/deploy@v1
ğŸš€ 1 description(s) will be deployed.
ğŸ‘Œ Target project is @polaris0208/ci-cd-sample
 â”” stage: main
ğŸ‰ 1 apps deployed
âœ… Success - deploy
```

## Dockerfile
- **Docker Image**ë¥¼ ë§Œë“¤ê¸°ìœ„í•œ í™˜ê²½ ì„¤ì •

### ì‘ì„±

```yaml
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì„ íƒ
FROM python:3.9-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì¢…ì†ì„± íŒŒì¼ ë³µì‚¬
COPY requirements.txt .

# ì¢…ì†ì„± ì„¤ì¹˜
RUN pip install --no-cache-dir -r requirements.txt

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV GREETING="Hello from Docker!"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["python", "app.py"]
```

### app ì‘ì„±

```py
import os

def main():
    # í™˜ê²½ ë³€ìˆ˜ GREETING ê°€ì ¸ì˜¤ê¸°, ê¸°ë³¸ê°’ ì„¤ì •
    greeting = os.getenv("GREETING", "Hello, World!")
    print(greeting)

if __name__ == "__main__":
    main()
```

### `requirements.txt` ì‘ì„±

```
flask
```

### ë¹Œë“œ ë° ì‹¤í–‰

```bash
docker build -t python-app .
# ì´ë¦„ ë””ë ‰í† ë¦¬
docker run python-app
# ì‹¤í–‰
Hello from Docker!
# ê²°ê³¼
```

## Docker Compose
- ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆì˜ ì„¤ì •ì„ `YAML` íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ì •ì˜
- ë„¤íŠ¸ì›Œí¬ ì„¤ì •, í™˜ê²½ ë³€ìˆ˜, ë³¼ë¥¨ ê´€ë¦¬ ë“±ì„ ê°„ë‹¨í•˜ê²Œ ì„¤ì •

### `docker-compose.yml`
- `web` - `db` ë¡œ êµ¬ì„±
  - `db` ê°€ êµ¬ë™ ë˜ë©´ `web` êµ¬ë™
  - `db` : `PostgreSQL` 
    - ì˜¤í”ˆì†ŒìŠ¤ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ
    - `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ì‚¬ìš©ì, ë¹„ë°€ë²ˆí˜¸, ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¤ì •
  - `DATABASE_URL=postgres://postgres:password@db:5432/mydatabase`
    - `PostgreSQL` ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ê¸° ìœ„í•œ **URL** í˜•ì‹
    - `postgres://:` : `PostgreSQL` ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê°€ë¦¬í‚¤ë©°, ê¸°ë³¸ì ìœ¼ë¡œ `postgresql` ë˜ëŠ”` postgres`ë¥¼ ì‚¬ìš©
    - `postgres:` : ì‚¬ìš©ìì˜ ì´ë¦„
    - `password@` : ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤. ì‹¤ì œ ì‚¬ìš© ì‹œì—ëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë” ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
    - `db:` : ì„œë²„ê°€ ì‹¤í–‰ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ì´ë¦„
    - `5432` : ê¸°ë³¸ í¬íŠ¸
    - `mydatabase` : ë°ì´í„°ë² ì´ìŠ¤ì˜ ì´ë¦„

```yaml
services:
  web:
    build: .
    container_name: python-web
    ports:
      - "5000:5000"
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/mydatabase
    volumes:
      - .:/app
    depends_on:
      - db

  db:
    image: postgres:13
    container_name: python-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mydatabase
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

### `requirements.txt` ì¶”ê°€

```
Flask==2.3.2
psycopg2-binary==2.9.6
Werkzeug==2.3.4
```

### `app.py`
- `db`ì— ì ‘ì†í•˜ì—¬ `user`ë¥¼ ê²€ìƒ‰ í›„ ë¬¸ìì—´ì— í¬í•¨
- `conn.cursor()` : `db`ì— **SQL** ì¿¼ë¦¬ ì…ë ¥
- `fetchall()` : ê²€ìƒ‰ëœ í•­ëª© ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°

```py
import os
from flask import Flask
import psycopg2

app = Flask(__name__)

# PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
DATABASE_URL = os.getenv('DATABASE_URL', 'postgres://postgres:password@db:5432/mydatabase')

@app.route('/')
def hello_world():
    # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
    conn = psycopg2.connect(DATABASE_URL)
    cursor = conn.cursor()
    
    # users í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì¡°íšŒ
    cursor.execute("SELECT * FROM users;")
    users = cursor.fetchall()
    
    # ì—°ê²° ì¢…ë£Œ
    cursor.close()
    conn.close()
    
    # ê²°ê³¼ë¥¼ ë¬¸ìì—´ë¡œ ë°˜í™˜
    return f"Hello, World! Users: {users}"

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')
```

### ì‹¤í–‰
- `docker-compose up --build`

## ëª¨ë‹ˆí„°ë§
- `docker stats` : ì‹œìŠ¤í…œ ìì› ì‚¬ìš©ëŸ‰ í™•ì¸
- `htop` : ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§, í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬